// schema.prisma - Esquema combinado con soporte completo para reportes financieros

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ========== ENUMS ==========

// Nuevos enums para reportes financieros
enum PaymentType {
  CASH
  CARD
  TRANSFER
  CHECK
  OTHER
}

enum Currency {
  MXN
  USD
  EUR
}

// Enum expandido para tipos de movimiento con más granularidad
enum MovementType {
  PAYMENT
  EXTENSION
  CANCELLATION
  EXTRA_CHARGE
  REFUND
  OTHER
  // Nuevos tipos específicos para reportes
  LODGING_PAYMENT    // Pago por hospedaje
  CASH_PAYMENT       // Pago en efectivo
  CARD_PAYMENT       // Pago con tarjeta
  SERVICE_CHARGE     // Cargo por servicios
  DISCOUNT           // Descuentos aplicados
}

enum RoomType {
  SENCILLA
  SENCILLA_ESPECIAL
  DOBLE
  DOBLE_ESPECIAL
  SUITE_A
  SUITE_B
}

enum RoomStatus {
  LIBRE
  RESERVADA
  SUCIA
  BLOQUEADA
  OCUPADA
  EN_MANTENIMIENTO
  LIMPIEZA
}

enum UserRole {
  ADMIN
  RECEPTIONIST
  HOUSEKEEPER
  SUPERADMIN
}

enum EmployeeStatus {
  ACTIVE
  INACTIVE
  ON_LEAVE
  TERMINATED
  SUSPENDED
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  HALF_DAY
  ON_LEAVE
}

enum BookingEventType {
  CHECKIN
  CHECKOUT
  EXTENSION
  NO_SHOW
  EARLY_CHECKOUT
  OTHER
}

// ========== MODELOS PRINCIPALES ==========

model Guest {
  id          Int       @id @default(autoincrement())
  firstName   String
  lastName    String
  email       String    @unique
  phoneNumber String
  address     String?
  bookings    Booking[]
}

model Room {
  id              Int               @id @default(autoincrement())
  roomNumber      String            @unique
  type            RoomType          @default(SENCILLA)
  capacity        Int               @default(2)
  pricePerNight   Decimal           @db.Decimal(10, 2)
  description     String?
  amenities       String[]          @default([])
  isAvailable     Boolean           @default(true)
  bookingRooms    BookingRoom[]
  roomInventory   RoomInventory?
  channelRates    ChannelRate[]
  status          RoomStatus        @default(LIBRE)
  floor           Int               @default(1)
  BookingMovement BookingMovement[]
}

model Booking {
  id              Int                   @id @default(autoincrement())
  guestId         Int
  checkInDate     DateTime              @db.Date
  checkOutDate    DateTime              @db.Date
  totalPrice      Decimal               @db.Decimal(10, 2)
  status          String
  guest           Guest                 @relation(fields: [guestId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  numberOfGuests  Int                   @default(1)
  bookingRooms    BookingRoom[]
  payments        Payment[]
  modifications   BookingModification[]
  BookingMovement BookingMovement[]
  BookingEvent    BookingEvent[]
}

// Modelo Payment actualizado con campos para reportes financieros
model Payment {
  id            Int         @id @default(autoincrement())
  bookingId     Int
  amount        Decimal     @db.Decimal(10, 2)
  paymentDate   DateTime    @db.Date
  paymentMethod String
  
  // Nuevos campos para reportes y auditoría
  turnoId       Int?        // Turno en que se registró el pago
  userId        Int?        // Usuario que registró el pago
  currency      Currency    @default(MXN)
  paymentType   PaymentType @default(CASH)
  description   String?     // Descripción del pago
  reference     String?     // Referencia o folio
  
  // Campos de auditoría
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  // Relaciones
  booking       Booking     @relation(fields: [bookingId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  turno         Turno?      @relation(fields: [turnoId], references: [numero])
  user          User?       @relation(fields: [userId], references: [id])
}

// ========== MODELOS DE USUARIO Y STAFF ==========

model User {
  id              Int                @id @default(autoincrement())
  username        String             @unique
  name            String
  lastName        String?
  passwordHash    String
  email           String             @unique
  role            UserRole           @default(RECEPTIONIST)
  departmentId    Int?
  position        String?
  hireDate        DateTime?          @db.Date
  status          EmployeeStatus     @default(ACTIVE)
  
  // Relaciones existentes
  department      Department?        @relation(fields: [departmentId], references: [id])
  attendance      Attendance[]
  schedules       Schedule[]
  documents       EmployeeDocument[]
  BookingMovement BookingMovement[]
  BookingEvent    BookingEvent[]
  
  // Nuevas relaciones para reportes
  payments        Payment[]          // Pagos registrados por el usuario
}

model Department {
  id          Int     @id @default(autoincrement())
  name        String  @unique
  description String?
  users       User[]
}

model Attendance {
  id           Int              @id @default(autoincrement())
  userId       Int
  checkInTime  DateTime
  checkOutTime DateTime?
  date         DateTime         @db.Date
  status       AttendanceStatus
  notes        String?
  user         User             @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
}

model Schedule {
  id          Int      @id @default(autoincrement())
  userId      Int
  startTime   DateTime
  endTime     DateTime
  dayOfWeek   Int // 0-6, Sunday-Saturday
  isRecurring Boolean  @default(true)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
}

model EmployeeDocument {
  id           Int       @id @default(autoincrement())
  userId       Int
  documentType String
  documentName String
  documentUrl  String
  uploadDate   DateTime  @default(now())
  expiryDate   DateTime?
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
}

// ========== MODELOS DE INVENTARIO Y CANALES ==========

model RoomInventory {
  id                  Int       @id @default(autoincrement())
  roomId              Int       @unique
  maintenanceStatus   String
  lastMaintenanceDate DateTime? @db.Date
  room                Room      @relation(fields: [roomId], references: [id], onDelete: Cascade, onUpdate: Cascade)
}

model Amenity {
  id          Int     @id @default(autoincrement())
  name        String  @unique
  description String?
  isAvailable Boolean @default(true)
}

model Channel {
  id           Int           @id @default(autoincrement())
  channelName  String        @unique
  contactInfo  String?
  channelRates ChannelRate[]
}

model ChannelRate {
  id        Int      @id @default(autoincrement())
  roomId    Int
  channelId Int
  rate      Decimal  @db.Decimal(10, 2)
  startDate DateTime @db.Date
  endDate   DateTime @db.Date
  room      Room     @relation(fields: [roomId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  channel   Channel  @relation(fields: [channelId], references: [id], onDelete: Cascade, onUpdate: Cascade)
}

model BookingSource {
  id         Int    @id @default(autoincrement())
  sourceName String @unique
}

model BookingModification {
  id                  Int      @id @default(autoincrement())
  bookingId           Int
  modificationDate    DateTime @db.Date
  modificationDetails String
  booking             Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade, onUpdate: Cascade)
}

// ========== MODELOS DE RELACIONES ==========

// Modelo para manejar la relación muchos a muchos entre Booking y Room
model BookingRoom {
  id          Int     @id @default(autoincrement())
  bookingId   Int
  roomId      Int
  priceAtTime Decimal @db.Decimal(10, 2)
  booking     Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  room        Room    @relation(fields: [roomId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@unique([bookingId, roomId]) // Asegura que no haya duplicados
}

// ========== MOVIMIENTOS Y EVENTOS DE RESERVAS ==========

// Modelo BookingMovement actualizado con campos para reportes financieros
model BookingMovement {
  id        Int          @id @default(autoincrement())
  bookingId Int
  roomId    Int?         // Para asociar el movimiento a una habitación específica si aplica
  type      MovementType
  amount    Decimal?     @db.Decimal(10, 2)
  subtotal  Decimal?     @db.Decimal(10, 2) // Para reportes
  iva       Decimal?     @db.Decimal(10, 2) // IVA calculado
  tax3      Decimal?     @db.Decimal(10, 2) // Impuesto 3%
  total     Decimal?     @db.Decimal(10, 2) // Total con impuestos
  reference String?      // Referencia o folio
  concept   String?      // Descripción del concepto
  createdAt DateTime     @default(now())
  
  // Nuevos campos obligatorios para reportes
  turnoId   Int?         // Turno en el que se registró el movimiento
  userId    Int?         // Usuario que registró el movimiento (usuario logueado)
  currency  Currency     @default(MXN) // Moneda con la que se pagó
  paymentType PaymentType? // Tipo de pago cuando aplique
  
  // Relaciones
  booking   Booking      @relation(fields: [bookingId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  room      Room?        @relation(fields: [roomId], references: [id])
  turno     Turno?       @relation(fields: [turnoId], references: [numero])
  user      User?        @relation(fields: [userId], references: [id])
}

model BookingEvent {
  id        Int              @id @default(autoincrement())
  bookingId Int
  eventType BookingEventType
  eventDate DateTime         @default(now())
  userId    Int?
  notes     String?
  booking   Booking          @relation(fields: [bookingId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  user      User?            @relation(fields: [userId], references: [id])
}

// ========== TURNOS PARA REPORTES ==========

// Modelo Turno actualizado con relaciones para reportes financieros
model Turno {
  numero      Int               @id // 1, 2, 3
  nombre      String            // Ej: "Turno Matutino"
  inicio      DateTime          // Hora de inicio del turno
  fin         DateTime          // Hora de fin del turno
  descripcion String?           // Descripción adicional del turno
  activo      Boolean           @default(true) // Si el turno está activo
  
  // Relaciones para reportes
  movimientos BookingMovement[] // Movimientos registrados en este turno
  payments    Payment[]         // Pagos registrados en este turno
  
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
}
